server:
  port: 8080

spring:
  application:
    name: telemetry-bridge

  main:
    web-application-type: reactive

  cloud:
    function:
      definition: mqttSource;mqttToKafka

    stream:
      # if you ever add other binders later, this keeps behavior explicit
      default-binder: kafka

      bindings:
        # 1) MQTT source -> "internal" stream destination
        mqttSource-out-0:
          destination: mqtt.internal.telemetry
          content-type: application/json

        # 2) internal stream -> transformer
        mqttToKafka-in-0:
          destination: mqtt.internal.telemetry
          content-type: application/json
          group: mqtt-bridge              # IMPORTANT (missing)
          dlqName: iot.plant.events.dlq

        # 3) transformer -> final Kafka topic
        mqttToKafka-out-0:
          destination: iot.plant.events.raw
          content-type: application/json

      kafka:
        binder:
          brokers: ${SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS:localhost:9092}
          auto-create-topics: true        # dev-friendly
          configuration:
            acks: all
            linger.ms: 5

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,env
  endpoint:
    health:
      show-details: always

logging:
  level:
    root: INFO
    org.springframework.cloud.stream: INFO
    reactor.kafka: WARN

app:
  mqtt:
    host: ${APP_MQTT_HOST:localhost}
    port: ${APP_MQTT_PORT:1883}
    username: ${APP_MQTT_USERNAME:}
    password: ${APP_MQTT_PASSWORD:}
    client-id: ${APP_MQTT_CLIENT_ID:smart-watering-be}
    ssl-enabled: ${APP_MQTT_SSL_ENABLED:false}

