server:
  port: 8080

spring:
  application:
    name: telemetry-bridge

  main:
    web-application-type: reactive

  cloud:
    function:
      # Use '|' if you want composition (mqttSource -> mqttToKafka).
      # If you keep them independent, use ';'
      definition: mqttSource;mqttToKafka

    stream:
      default-binder: kafka

      bindings:
        mqttSource-out-0:
          destination: mqtt.internal.telemetry
          content-type: application/json

        mqttToKafka-in-0:
          destination: mqtt.internal.telemetry
          content-type: application/json
          group: mqtt-bridge

        mqttToKafka-out-0:
          destination: iot.plant.events.raw
          content-type: application/json
          producer:
            # this matches what you're setting in code: KafkaHeaders.KEY
            partition-key-expression: "headers['kafka_messageKey']"

      kafka:
        binder:
          bootstrap-servers: ${SPRING_KAFKA_BOOTSTRAP_SERVERS:kafka:9092}
          producer:
            key-serializer: org.apache.kafka.common.serialization.StringSerializer
            value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
            properties:
              acks: all
              enable.idempotence: true
              max.in.flight.requests.per.connection: 5
              retries: 10
          auto-create-topics: true
          configuration:
            acks: all
            linger.ms: 5

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,env
  endpoint:
    health:
      show-details: always

logging:
  level:
    root: INFO
    org.springframework.cloud.stream: INFO
    reactor.kafka: WARN

app:
  mqtt:
    # IMPORTANT: must include scheme
    broker-uri: ${APP_MQTT_BROKER_URI:tcp://${APP_MQTT_HOST:localhost}:${APP_MQTT_PORT:1883}}
    client-id: ${APP_MQTT_CLIENT_ID:telemetry-bridge}
    topic: ${APP_MQTT_TOPIC:mqtt.internal.telemetry}
    qos: ${APP_MQTT_QOS:1}
    username: ${APP_MQTT_USERNAME:}
    password: ${APP_MQTT_PASSWORD:}
