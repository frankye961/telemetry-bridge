name: telemetry-bridge CD

on:
  push:
    branches: ["main"]

concurrency:
  group: cd-dev
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  deploy-dev:
    name: Deploy to dev (self-hosted)
    runs-on: self-hosted
    environment: dev

    env:
      DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}      # e.g. /opt/telemetry-bridge
      SERVICE_NAME: ${{ vars.SERVICE_NAME }}    # e.g. telemetry-bridge
      REGISTRY: ghcr.io

    steps:
      - name: Sanity checks
        shell: bash
        run: |
          set -euxo pipefail
          whoami
          id
          groups
          docker version
          docker compose version
          echo "DEPLOY_PATH=$DEPLOY_PATH"
          echo "SERVICE_NAME=$SERVICE_NAME"
          test -d "$DEPLOY_PATH"
          test -f "$DEPLOY_PATH/docker-compose.yml"
          test -f "$DEPLOY_PATH/.env"
          ls -la "$DEPLOY_PATH"

      - name: Login to GHCR (only needed for private images)
        shell: bash
        run: |
          set -euxo pipefail
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login "$REGISTRY" \
            -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

      - name: Deploy (pull + restart service)
        shell: bash
        run: |
          set -euxo pipefail
          cd "$DEPLOY_PATH"

          echo "==> docker compose config (validate interpolation)"
          docker compose config

          echo "==> Pull"
          docker compose pull "$SERVICE_NAME"

          echo "==> Up"
          docker compose up -d --no-deps "$SERVICE_NAME"

          echo "==> docker ps"
          docker ps

      - name: Show service logs on failure
        if: failure()
        shell: bash
        run: |
          set -euxo pipefail
          cd "$DEPLOY_PATH"
          docker compose ps || true
          docker compose logs --no-color --tail=300 "$SERVICE_NAME" || true
